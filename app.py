import streamlit as st
import google.generativeai as genai

# 1. ЁЯФС API Setup via Streamlit Secrets
try:
    genai.configure(api_key=st.secrets["GEMINI_API_KEY"])
    # 1.5 Flash is used for the fastest possible response times
    model = genai.GenerativeModel("gemini-2.5-flash")
except Exception:
    st.error("API Key not found. Please add 'GEMINI_API_KEY' to your Secrets.")

# 2. тЪб Multilingual Dictionary (Stored in Session to prevent re-loading)
if "translations" not in st.session_state:
    st.session_state.translations = {
        "English": {"title": "ЁЯМ▒ Smart Farming Assistant", "loc": "Location", "stage": "Stage", "stages": ["Planting", "Growing", "Harvesting"], "const": "Constraints", "ask": "Your question", "btn": "Get Advice", "header": "Advice", "err": "Enter a question."},
        "Hindi (рд╣рд┐рдиреНрджреА)": {"title": "ЁЯМ▒ рд╕реНрдорд╛рд░реНрдЯ рдЦреЗрддреА рд╕рд╣рд╛рдпрдХ", "loc": "рд╕реНрдерд╛рди", "stage": "рдЪрд░рдг", "stages": ["рдмреБрд╡рд╛рдИ", "рдмрдврд╝рдд", "рдХрдЯрд╛рдИ"], "const": "рд╕реАрдорд╛рдПрдВ", "ask": "рдкреНрд░рд╢реНрди", "btn": "рд╕рд▓рд╛рд╣ рд▓реЗрдВ", "header": "рд╕реБрдЭрд╛рд╡", "err": "рдкреНрд░рд╢реНрди рд▓рд┐рдЦреЗрдВред"},
        "Bengali (ржмрж╛ржВрж▓рж╛)": {"title": "ЁЯМ▒ рж╕рзНржорж╛рж░рзНржЯ ржлрж╛рж░рзНржорж┐ржВ рж╕рж╣ржХрж╛рж░рзА", "loc": "ржЕржмрж╕рзНржерж╛ржи", "stage": "ржкрж░рзНржпрж╛рзЯ", "stages": ["рж░рзЛржкржг", "ржмрзГржжрзНржзрж┐", "ржХрж╛ржЯрж╛"], "const": "рж╕рзАржорж╛ржмржжрзНржзрждрж╛", "ask": "ржкрзНрж░рж╢рзНржи", "btn": "ржкрж░рж╛ржорж░рзНрж╢", "header": "ржкрж░рж╛ржорж░рзНрж╢", "err": "ржкрзНрж░рж╢рзНржи рж▓рж┐ржЦрзБржиред"},
        "Telugu (р░др▒Жр░▓р▒Бр░Чр▒Б)": {"title": "ЁЯМ▒ р░╕р▒Нр░ор░╛р░░р▒Нр░Яр▒Н р░лр░╛р░░р▒Нр░ор░┐р░Вр░Чр▒Н р░Ер░╕р░┐р░╕р▒Нр░Яр▒Жр░Вр░Яр▒Н", "loc": "р░кр▒Нр░░р░╛р░Вр░др░В", "stage": "р░жр░╢", "stages": ["р░ир░╛р░Яр░бр░В", "р░кр▒Жр░░р▒Бр░Чр▒Бр░жр░▓", "р░Хр▒Лр░д"], "const": "р░кр░░р░┐р░ор░┐р░др▒Бр░▓р▒Б", "ask": "р░ор▒А р░кр▒Нр░░р░╢р▒Нр░и", "btn": "р░╕р░▓р░╣р░╛", "header": "р░╕р░▓р░╣р░╛", "err": "р░кр▒Нр░░р░╢р▒Нр░и р░░р░╛р░пр░Вр░бр░┐."},
        "Marathi (рдорд░рд╛рдареА)": {"title": "ЁЯМ▒ рд╕реНрдорд╛рд░реНрдЯ рд╢реЗрддреА рд╕рд╣рд╛рдпреНрдпрдХ", "loc": "рдард┐рдХрд╛рдг", "stage": "рдЕрд╡рд╕реНрдерд╛", "stages": ["рд▓рд╛рдЧрд╡рдб", "рд╡рд╛рдв", "рдХрд╛рдврдгреА"], "const": "рдорд░реНрдпрд╛рджрд╛", "ask": "рддреБрдордЪрд╛ рдкреНрд░рд╢реНрди", "btn": "рд╕рд▓реНрд▓рд╛", "header": "рд╕рд▓реНрд▓рд╛", "err": "рдкреНрд░рд╢реНрди рд▓рд┐рд╣рд╛."},
        "Tamil (родрооро┐ро┤рпН)": {"title": "ЁЯМ▒ ро╕рпНрооро╛ро░рпНроЯрпН ро╡ро┐ро╡роЪро╛роп роЙродро╡ро┐ропро╛ро│ро░рпН", "loc": "роЗро░рпБрокрпНрокро┐роЯроорпН", "stage": "роиро┐ро▓рпИ", "stages": ["роироЯро╡рпБ", "ро╡ро│ро░рпНроЪрпНроЪро┐", "роЕро▒рпБро╡роЯрпИ"], "const": "роХроЯрпНроЯрпБрокрпНрокро╛роЯрпБроХро│рпН", "ask": "роХрпЗро│рпНро╡ро┐", "btn": "роЖро▓рпЛроЪройрпИ", "header": "роЖро▓рпЛроЪройрпИ", "err": "роХрпЗро│рпНро╡ро┐ропрпИ роЙро│рпНро│ро┐роЯро╡рпБроорпН."},
        "Urdu (╪з╪▒╪п┘И)": {"title": "ЁЯМ▒ ╪│┘Е╪з╪▒┘╣ ┘Б╪з╪▒┘Е┘Ж┌п ╪з╪│╪│┘╣┘Ж┘╣", "loc": "┘Е┘В╪з┘Е", "stage": "┘Е╪▒╪н┘Д█Б", "stages": ["┌й╪з╪┤╪к", "┘Ж╪┤┘И┘И┘Ж┘Е╪з", "┌й┘╣╪з╪ж█М"], "const": "┘╛╪з╪и┘Ж╪п█М╪з┌║", "ask": "╪│┘И╪з┘Д", "btn": "┘Е╪┤┘И╪▒█Б", "header": "┘Е╪┤┘И╪▒█Б", "err": "╪│┘И╪з┘Д ┘Д┌й┌╛█М┌║█Ф"},
        "Gujarati (ркЧрлБркЬрк░рк╛ркдрлА)": {"title": "ЁЯМ▒ рк╕рлНркорк╛рк░рлНркЯ рклрк╛рк░рлНркорк┐ркВркЧ рк╕рк╣рк╛ркпркХ", "loc": "рк╕рлНркерк╛рки", "stage": "ркдркмркХрлНркХрлЛ", "stages": ["рк╡рк╛рк╡ркгрлА", "рк╡рк┐ркХрк╛рк╕", "рк▓ркгркгрлА"], "const": "ркорк░рлНркпрк╛ркжрк╛ркУ", "ask": "рккрлНрк░рк╢рлНрки", "btn": "рк╕рк▓рк╛рк╣", "header": "рк╕рк▓рк╛рк╣", "err": "рккрлНрк░рк╢рлНрки рк▓ркЦрлЛ."},
        "Kannada (р▓Хр▓ир│Нр▓ир▓б)": {"title": "ЁЯМ▒ р▓╕р│Нр▓ор▓╛р▓░р│Нр▓Яр│Н р▓Хр│Гр▓╖р▓┐ р▓╕р▓╣р▓╛р▓пр▓Х", "loc": "р▓╕р│Нр▓ер▓│", "stage": "р▓╣р▓Вр▓д", "stages": ["р▓мр▓┐р▓др│Нр▓др▓ир│Ж", "р▓мр│Жр▓│р▓╡р▓гр▓┐р▓Чр│Ж", "р▓Хр▓Яр▓╛р▓╡р│Б"], "const": "р▓ор▓┐р▓др▓┐р▓Чр▓│р│Б", "ask": "р▓кр│Нр▓░р▓╢р│Нр▓ир│Ж", "btn": "р▓╕р▓▓р▓╣р│Ж", "header": "р▓╕р▓▓р▓╣р│Ж", "err": "р▓кр│Нр▓░р▓╢р│Нр▓ир│Ж р▓мр▓░р│Жр▓пр▓┐р▓░р▓┐."},
        "Odia (рмУрмбрм╝рм┐рмЖ)": {"title": "ЁЯМ▒ рм╕рнНрморм╛рм░рнНрмЯ рмХрнГрм╖рм┐ рм╕рм╣рм╛рнЯрмХ", "loc": "рм╕рнНрмерм╛рми", "stage": "рмкрм░рнНрмпрнНрнЯрм╛рнЯ", "stages": ["рммрнБрмгрм┐рммрм╛", "рммрмврм┐рммрм╛", "рмЕрморм│"], "const": "рмкрнНрм░рмдрм┐рммрмирнНрмзрмХ", "ask": "рмкрнНрм░рм╢рнНрми", "btn": "рмкрм░рм╛рморм░рнНрм╢", "header": "рмкрм░рм╛рморм░рнНрм╢", "err": "рмкрнНрм░рм╢рнНрми рм▓рнЗрмЦрмирнНрмдрнБред"},
        "Malayalam (р┤ор┤▓р┤пр┤╛р┤│р┤В)": {"title": "ЁЯМ▒ р┤╕р╡Нр┤ор┤╛р╡╝р┤Яр╡Нр┤Яр╡Н р┤лр┤╛р┤ор┤┐р┤Вр┤Чр╡Н р┤Ер┤╕р┤┐р┤╕р╡Нр┤▒р╡Нр┤▒р┤ир╡Нр┤▒р╡Н", "loc": "р┤╕р╡Нр┤ер┤▓р┤В", "stage": "р┤Шр┤Яр╡Нр┤Яр┤В", "stages": ["р┤ир┤Яр╡Ар╡╜", "р┤╡р┤│р╡╝р┤Ър╡Нр┤Ъ", "р┤╡р┤┐р┤│р┤╡р╡Жр┤Яр╡Бр┤кр╡Нр┤кр╡Н"], "const": "р┤кр┤░р┤┐р┤ор┤┐р┤др┤┐р┤Хр╡╛", "ask": "р┤Ър╡Лр┤жр╡Нр┤пр┤В", "btn": "р┤Йр┤кр┤жр╡Зр┤╢р┤В", "header": "р┤Йр┤кр┤жр╡Зр┤╢р┤В", "err": "р┤Ър╡Лр┤жр╡Нр┤пр┤В р┤ир╡╜р┤Хр╡Бр┤Х."},
        "Punjabi (рикрй░риЬри╛римрйА)": {"title": "ЁЯМ▒ ри╕риори╛ри░риЯ риЦрйЗридрйА ри╕ри╣ри╛риЗриХ", "loc": "ри╕риери╛рии", "stage": "рикрйЬри╛риЕ", "stages": ["римри┐риЬри╛риИ", "ри╡ри╛ризри╛", "риХриЯри╛риИ"], "const": "рикри╛римрй░рижрйАриЖриВ", "ask": "ри╕ри╡ри╛ри▓", "btn": "ри╕ри▓ри╛ри╣", "header": "ри╕ри▓ри╛ри╣", "err": "ри╕ри╡ри╛ри▓ ри▓ри┐риЦрйЛред"},
        "Assamese (ржЕрж╕ржорзАржпрж╝рж╛)": {"title": "ЁЯМ▒ рж╕рзНржорж╛рз░рзНржЯ ржХрзГрж╖рж┐ рж╕рж╣рж╛ржпрж╝ржХ", "loc": "рж╕рзНржерж╛ржи", "stage": "ржкрз░рзНржпрж╛рзЯ", "stages": ["рз░рзЛржкржг", "ржмрзГржжрзНржзрж┐", "ржЪржкрзЛрз▒рж╛"], "const": "рж╕рзАржорж╛ржмржжрзНржзрждрж╛", "ask": "ржкрзНрз░рж╢рзНржи", "btn": "ржкрз░рж╛ржорз░рзНрж╢", "header": "ржкрз░рж╛ржорз░рзНрж╢", "err": "ржкрзНрз░рж╢рзНржи рж▓рж┐ржЦржХред"},
        "Maithili (рдореИрдерд┐рд▓реА)": {"title": "ЁЯМ▒ рд╕реНрдорд╛рд░реНрдЯ рдХреГрд╖рд┐ рд╕рд╣рд╛рдпрдХ", "loc": "рд╕реНрдерд╛рди", "stage": "рдЪрд░рдг", "stages": ["рд░реЛрдкрдиреА", "рд╡рд┐рдХрд╛рд╕", "рдХрдЯрдиреА"], "const": "рд╕реАрдорд╛", "ask": "рдкреНрд░рд╢реНрди", "btn": "рд╕рд▓рд╛рд╣", "header": "рд╕рд▓рд╛рд╣", "err": "рдкреНрд░рд╢реНрди рд▓рд┐рдЦреВред"},
        "Santali (с▒ес▒Яс▒▒с▒Ыс▒Яс▒▓с▒д)": {"title": "ЁЯМ▒ с▒ес▒вс▒Яс▒ис▒┤ с▒кс▒Яс▒е с▒Ьс▒Ъс▒▓с▒Ъс▒нс▒дс▒б", "loc": "с▒бс▒Яс▒нс▒Ьс▒Я", "stage": "с▒Ъс▒ас▒Ыс▒Ъ", "stages": ["с▒ис▒Ъс▒жс▒Ъс▒н", "с▒жс▒Яс▒ис▒Яс▒Ь", "с▒дс▒и"], "const": "с▒╡с▒Яс▒лс▒╖с▒Я", "ask": "с▒ас▒йс▒Юс▒дс▒нс▒Яс▒в", "btn": "с▒╡с▒йс▒лс▒╖с▒д", "header": "с▒╡с▒йс▒лс▒╖с▒д", "err": "с▒ас▒йс▒ас▒Юс▒д с▒Ъс▒Ю с▒вс▒о"},
        "Kashmiri (┌й┘▓╪┤┘П╪▒)": {"title": "ЁЯМ▒ ╪│┘Е╪з╪▒┘╣ ┌й┘▓╪┤╪к█М ┘Е╪п╪п┌п╪з╪▒", "loc": "╪м╪з╪ж█Т", "stage": "╪н╪з┘Д╪к", "stages": ["╪к╪о┘Е ╪▒█М╪▓█М", "╪и█Ж┌И ┌п┌Ш┌╛┘П┘Ж", "┘Д█Ж┘Ж┘П┘Ж"], "const": "╪▒┘П┌й╪з┘И┘╣", "ask": "╪│┘И╪з┘Д", "btn": "┘Е╪┤┘И╪▒█Б", "header": "┘Е╪┤┘И╪▒█Б", "err": "╪│┘И╪з┘Д ┘Д┌й┌╛┘И"},
        "Nepali (рдиреЗрдкрд╛рд▓реА)": {"title": "ЁЯМ▒ рд╕реНрдорд╛рд░реНрдЯ рдХреГрд╖рд┐ рд╕рд╣рд╛рдпрдХ", "loc": "рд╕реНрдерд╛рди", "stage": "рдЕрд╡рд╕реНрдерд╛", "stages": ["рд░реЛрдкрдг", "рд╡реГрджреНрдзрд┐", "рдХрдЯрд╛рдиреА"], "const": "рд╕реАрдорд╛рд╣рд░реВ", "ask": "рдкреНрд░рд╢реНрди", "btn": "рд╕рд▓реНрд▓рд╛рд╣", "header": "рд╕рд▓реНрд▓рд╛рд╣", "err": "рдкреНрд░рд╢реНрди рд▓реЗрдЦреНрдиреБрд╣реЛрд╕реНред"},
        "Konkani (рдХреЛрдВрдХрдгреА)": {"title": "ЁЯМ▒ рд╕реНрдорд╛рд░реНрдЯ рд╢реЗрддреА рд╕рд╣рд╛рдпреНрдпрдХ", "loc": "рд╕реБрд╡рд╛рдд", "stage": "рдЕрд╡рд╕реНрдерд╛", "stages": ["рд▓рд╛рд╡рдб", "рд╡рд╛рдв", "рдХрд╛рдврдгреА"], "const": "рдорд░реНрдпрд╛рджрд╛", "ask": "рдкреНрд░рд╢реНрди", "btn": "рд╕рд▓реНрд▓реЛ", "header": "рд╕рд▓реНрд▓реЛ", "err": "рдкреНрд░рд╢реНрди рдмрд░рдпрд╛рддред"},
        "Sindhi (╪│┘Ж┌М┘К)": {"title": "ЁЯМ▒ ╪│┘Е╪з╪▒┘╜ ┘Б╪з╪▒┘Е┘Ж┌п ┘Е╪п╪п┌п╪з╪▒", "loc": "╪м┌│┘З┘З", "stage": "┘Е╪▒╪н┘Д┘И", "stages": ["┘╛┘И┘И┌й┘К", "┘И╪з┌М", "┘Д┘И┌П╪з"], "const": "╪▒┌к╪з┘И┘╜┘И┘Ж", "ask": "╪│┘И╪з┘Д", "btn": "╪╡┘Д╪з╪н", "header": "╪╡┘Д╪з╪н", "err": "╪│┘И╪з┘Д ┘Д┌й┌╛┘Иред"},
        "Dogri (рдбреЛрдЧрд░реА)": {"title": "ЁЯМ▒ рд╕реНрдорд╛рд░реНрдЯ рдЦреЗрддреА рд╕рд╣рд╛рдпрдХ", "loc": "рдерд╛рд╣рдВ", "stage": "рдЪрд░рдг", "stages": ["рдмрд┐рдЬрд╛рдИ", "рдмрдзрд╛рдИ", "рдХрдЯрд╛рдИ"], "const": "рд░реБрдХрд╛рд╡рдЯ", "ask": "рд╕реБрдЖрд▓", "btn": "рд╕рд▓рд╛рд╣", "header": "рд╕рд▓рд╛рд╣", "err": "рд╕реБрдЖрд▓ рд▓рд┐рдЦреЛред"},
        "Manipuri (ржорзИрждрзИрж▓рзЛржи)": {"title": "ЁЯМ▒ рж╕рзНржорж╛рж░рзНржд ржлрж╛рж░ржорж┐ржВ ржПрж╕рж┐рж╕рзНрждрзЗржирзНржд", "loc": "ржоржлржо", "stage": "ржкрж░рзНржпрж╛ржпрж╝", "stages": ["ржерж╛ржмрж╛", "ржЪрж╛ржЙржЦрзОржкрж╛", "рж▓рзЛржЙржмрж╛"], "const": "ржЕржпрж╝рзЗрзОржкрж╛", "ask": "рз▒рж╛рж╣ржВ", "btn": "ржкрж╛ржЙрждрж╛ржХ", "header": "ржкрж╛ржЙрждрж╛ржХ", "err": "рз▒рж╛рж╣ржВ ржЗржмрзАржпрж╝рзБред"},
        "Bodo (рдмрд░')": {"title": "ЁЯМ▒ рд╕реНрдорд╛рд░реНрдЯ рдЖрдмрд╛рдж рдЕрдирдерд╛рдпрдЧреНрд░рд╛", "loc": "рдЬрд╛рдпрдЧрд╛", "stage": "рдерд╛рдЦреЛ", "stages": ["рдЧрд╛рдпрдирд╛рдп", "рджреЗрд░рдирд╛рдп", "рд╣рд╛рдЦрд╛рдпржирж╛рдп"], "const": "рд╣реЗрдВрдерд╛", "ask": "рд╕реЛрдВрд▓реБ", "btn": "рд╕реБрдмреБрдВрдерд┐", "header": "рд╕реБрдмреБрдВрдерд┐", "err": "рд╕реЛрдВрд▓реБ рд▓рд┐рд░ред"},
        "Sanskrit (рд╕рдВрд╕реНрдХреГрддрдореН)": {"title": "ЁЯМ▒ рдЪрддреБрд░ рдХреГрд╖рд┐ рд╕рд╣рд╛рдпрдХ:", "loc": "рд╕реНрдерд╛рдирдореН", "stage": "рдЕрд╡рд╕реНрдерд╛", "stages": ["рд╡рдкрдирдореН", "рд╡рд░реНрдзрдирдореН", "рд▓рд╡рдирдореН"], "const": "рдкреНрд░рддрд┐рдмрдиреНрдзрд╛:", "ask": "рдкреНрд░рд╢реНрдирдВ", "btn": "рдкрд░рд╛рдорд░реНрд╢рдВ", "header": "рдкрд░рд╛рдорд░реНрд╢:", "err": "рдкреНрд░рд╢реНрдирдВ рд▓рд┐рдЦрддреБред"}
    }

# 3. ЁЯЦея╕П Interface Layout
st.set_page_config(page_title="AgriBot", page_icon="ЁЯМ▒", layout="centered")

# Language Selection
lang_list = list(st.session_state.translations.keys())
sel_lang = st.sidebar.selectbox("ЁЯМР Select Language / рднрд╛рд╖рд╛ рдЪреБрдиреЗрдВ", lang_list)
ui = st.session_state.translations[sel_lang]

st.title(ui["title"])

# Using a Form to prevent app refresh on every keystroke
with st.form("agri_input_form"):
    c1, c2 = st.columns(2)
    with c1:
        loc = st.text_input(ui["loc"])
    with c2:
        stg = st.selectbox(ui["stage"], ui["stages"])
    
    con = st.text_input(ui["const"])
    ques = st.text_area(ui["ask"])
    submitted = st.form_submit_button(ui["btn"])

# 4. тЪб Core AI Logic with Streaming Output
if submitted:
    if ques.strip():
        # Get clean language name (removes the native script for the AI)
        clean_lang = sel_lang.split(" (")[0]
        
        # High-context prompt for better farming advice
        prompt = (f"You are a professional agricultural consultant. "
                  f"Provide practical, safe, and actionable advice in the {clean_lang} language. "
                  f"Context - Location: {loc}, Crop Growth Stage: {stg}, Specific Constraints: {con}. "
                  f"Farmer's Question: {ques}. "
                  f"Format the answer in 3-5 clear bullet points.")
        
        st.divider()
        st.subheader(ui["header"])
        
        # Empty container for the live-streaming text
        res_container = st.empty()
        full_text = ""
        
        try:
            # Stream=True allows for word-by-word generation (fastest experience)
            response = model.generate_content(prompt, stream=True)
            for chunk in response:
                full_text += chunk.text
                res_container.markdown(full_text + "тЦМ") # Animated cursor
            res_container.markdown(full_text)
        except Exception as e:
            st.error("Error connecting to Gemini. Please check your internet or API limits.")
    else:
        st.error(ui["err"])
